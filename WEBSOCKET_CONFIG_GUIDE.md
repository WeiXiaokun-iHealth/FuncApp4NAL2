# WebSocket 配置功能使用指南

本指南介绍如何使用 FuncApp4NAL2 的 WebSocket 配置功能。

## 功能概述

FuncApp4NAL2 现在支持动态配置 WebSocket 服务器地址，包括：

1. **首次启动配置**：首次打开 App 时，自动显示配置页面
2. **自动扫描**：自动扫描附近可用的 WebSocket 服务
3. **手动输入**：支持手动输入自定义 WebSocket 地址
4. **重新检索**：在主页面可以随时重新扫描和配置服务

## 使用流程

### 首次启动

1. **启动应用**

   - 首次启动时，App 会显示 "WebSocket 配置" 页面
   - 自动开始快速扫描常用地址

2. **等待扫描结果**

   - 快速扫描会检查以下地址：
     - 192.168.1.106:3000
     - 192.168.0.106:3000
     - 172.20.10.2:3000
     - 10.0.0.2:3000
     - localhost:3000
     - 127.0.0.1:3000

3. **选择服务**

   - 如果找到可用服务，会显示在列表中
   - 点击选择你想要连接的服务
   - 选中的服务会高亮显示并有 ✓ 标记

4. **确认连接**
   - 点击 "确认并连接" 按钮
   - App 会保存配置并进入主页面

### 扫描选项

#### 快速扫描

- 扫描常用的 WebSocket 地址
- 速度快，适合大多数场景
- 点击 "快速扫描" 按钮执行

#### 完整扫描

- 扫描更广泛的 IP 地址范围
- 需要更长时间
- 点击 "完整扫描" 按钮执行
- 会提示确认是否继续

### 手动输入地址

如果自动扫描未找到服务，可以手动输入：

1. 点击 "▶ 手动输入地址" 展开输入框
2. 输入 WebSocket 地址，格式示例：
   - `192.168.1.100:3000`
   - `ws://192.168.1.100:3000`
3. 点击 "测试连接" 验证地址
4. 如果测试成功，会自动选中该地址
5. 点击 "确认并连接" 完成配置

### 主页面功能

配置完成后进入主页面，包含以下功能：

1. **连接状态显示**

   - 绿色圆点：已连接
   - 红色圆点：未连接
   - 显示当前连接的 WebSocket 地址

2. **重新连接按钮**

   - 如果连接断开，可以点击 "立即连接" 重新连接
   - 如果已连接，可以点击 "重新连接" 刷新连接

3. **重新检索按钮**（橙色）

   - 点击后可以重新扫描和选择 WebSocket 服务
   - 会清除当前配置并返回配置页面
   - 用于切换到不同的服务器

4. **数据处理**
   - 自动接收和处理来自 WebSocket 的 NAL2 请求
   - 显示输入和输出数据

## 配置存储

- WebSocket 配置会自动保存到设备本地存储
- 下次启动时会自动加载上次的配置
- 使用 AsyncStorage 存储，数据持久化

## 注意事项

### 网络要求

- 确保手机和 WebSocket 服务器在同一网络下
- WebSocket 服务必须正在运行
- 检查防火墙设置，确保端口未被阻止

### 常见端口

系统会扫描以下常用端口：

- 3000（默认开发端口）
- 8080（常用服务端口）
- 8000（备用端口）
- 3001（备用开发端口）
- 5000（Flask 默认端口）
- 9000（备用服务端口）

### 扫描超时

- 每个地址的扫描超时时间为 2 秒
- 如果网络较慢，可能需要等待更长时间
- 可以多次尝试扫描

## 故障排除

### 未找到任何服务

**可能原因：**

1. WebSocket 服务未启动
2. 手机和服务器不在同一网络
3. 防火墙阻止了连接
4. 端口配置不正确

**解决方法：**

1. 检查服务器端 WebSocket 服务是否运行
2. 确认网络连接
3. 尝试手动输入已知的服务器地址
4. 检查服务器日志

### 连接后立即断开

**可能原因：**

1. 服务器拒绝连接
2. 网络不稳定
3. 服务器配置问题

**解决方法：**

1. 检查服务器日志
2. 使用 "重新连接" 功能
3. 尝试 "重新检索" 并选择其他服务

### 无法保存配置

**可能原因：**

1. 存储权限问题
2. 设备存储空间不足

**解决方法：**

1. 检查应用权限设置
2. 清理设备存储空间
3. 重启应用

## 开发者信息

### 文件结构

```
utils/
  └── WebSocketScanner.js       # WebSocket 扫描工具类
components/
  ├── WebSocketConfigScreen.js  # 配置页面组件
  └── MainScreen.js              # 主页面组件
App.js                           # 应用入口，整合配置流程
```

### 配置存储格式

```json
{
  "url": "ws://192.168.1.106:3000",
  "name": "WebSocket Server (192.168.1.106:3000)",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### API 接口

WebSocketScanner 类提供以下方法：

- `quickScan()`: 快速扫描常用地址
- `scanNetwork(baseIP, startHost, endHost)`: 扫描 IP 范围
- `checkWebSocketServer(ip, port)`: 检查单个地址
- `testWebSocketURL(url)`: 测试 WebSocket URL

## 更新日志

### v1.0.0

- 初始版本
- 支持自动扫描和手动输入
- 支持配置保存和重新检索
- 集成到主应用流程

## 技术支持

如有问题或建议，请联系开发团队。
