# Android 模拟器使用指南

## 当前状态说明

您看到的日志：

```
❌ ERROR  启动服务器失败: [Error: EADDRINUSE]
❌ ERROR  启动服务器失败: [Error: EADDRINUSE]
✅ LOG  [Server] 端口 8080 被占用，尝试端口 8081...
✅ LOG  服务器已启动在端口 8081
✅ LOG  [Server] 服务器已启动: 0.0.0.0:8081
```

**这表示服务器已成功启动！** 前面的 ERROR 是端口探测过程，不是真正的错误。

## 模拟器的特殊性

### 1. IP 地址问题

在模拟器上显示`0.0.0.0`是正常的，因为：

- 模拟器没有真实的 WiFi 连接
- WifiManager 无法获取有效的 IP 地址
- 模拟器使用虚拟网络

### 2. 模拟器网络配置

Android 模拟器默认网络地址：

- **模拟器内部看自己：** `10.0.2.15`
- **宿主机访问模拟器：** `10.0.2.2`（反向，模拟器访问宿主机）
- **局域网其他设备：** 无法直接访问模拟器

## 解决方案

### 方案 1：使用真实设备（推荐）

在真实 Android 设备上运行，将获得真实的局域网 IP 地址（如 192.168.1.100），可以被局域网内的其他设备访问。

```bash
# 通过USB连接真实设备
adb devices

# 安装并运行
bash scripts/update-and-run-android.sh
```

### 方案 2：模拟器端口转发

如果必须使用模拟器，可以设置端口转发：

```bash
# 将宿主机的8080端口转发到模拟器的8081端口
adb forward tcp:8080 tcp:8081

# 现在可以通过 localhost:8080 访问模拟器内的服务器
```

然后在宿主机上测试：

```javascript
const ws = new WebSocket("ws://localhost:8080");
```

### 方案 3：修改代码支持模拟器

我们已经提供了改进的 IP 获取逻辑（见下文）。

## 测试连接

### 在模拟器中测试（自己连自己）

```javascript
// 模拟器访问自己
const ws = new WebSocket("ws://10.0.2.15:8081");
```

### 从宿主机测试

```bash
# 1. 设置端口转发
adb forward tcp:8080 tcp:8081

# 2. 在浏览器或Node.js中连接
const ws = new WebSocket('ws://localhost:8080');
```

### 从局域网其他设备测试

使用真实设备，无法从局域网访问模拟器。

## 推荐的开发流程

### 开发阶段（使用模拟器）

1. 在模拟器中开发和测试基本功能
2. 使用`adb forward`进行本地测试
3. Web 端运行在同一台电脑上

```bash
# 启动应用
bash scripts/update-and-run-android.sh

# 设置端口转发
adb forward tcp:8080 tcp:8081

# 在浏览器中打开 server/public/index.html
# 连接地址使用: ws://localhost:8080
```

### 测试阶段（使用真实设备）

1. 使用真实 Android 设备
2. 连接到局域网 WiFi
3. 获取真实 IP 地址
4. 从任何局域网设备连接

## 常见问题

### Q1: 为什么显示 0.0.0.0？

A: 模拟器没有真实 WiFi，无法获取 IP。这是正常现象。

### Q2: Web 端能连接模拟器吗？

A: 可以，但需要使用`adb forward`端口转发。

### Q3: 局域网其他设备能访问模拟器吗？

A: 不能。必须使用真实设备才能被局域网访问。

### Q4: 服务器真的启动了吗？

A: 是的！看到 "服务器已启动在端口 X" 就表示成功了。

## 生产部署

**重要：** 生产环境必须使用真实 Android 设备，因为：

- 需要真实的局域网连接
- 需要被其他设备访问
- 模拟器性能较差
- 模拟器网络受限

## 下一步

1. **开发测试：** 使用模拟器 + adb forward
2. **功能测试：** 使用真实设备
3. **生产部署：** 打包 APK 安装到真实设备

参考：

- `QUICK_START.md` - 快速开始
- `NEW_ARCHITECTURE.md` - 架构说明
